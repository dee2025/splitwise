\"use client\";\n\nimport { loginSuccess } from \"@/redux/slices/authSlice\";\nimport axios from \"axios\";\nimport { motion } from \"framer-motion\";\nimport { ArrowRight, Eye, EyeOff, Loader2, Lock, Mail, Phone, User, CheckCircle, ChevronLeft } from \"lucide-react\";\nimport Link from \"next/link\";\nimport { useRouter } from \"next/navigation\";\nimport { useEffect, useState } from \"react\";\nimport toast from \"react-hot-toast\";\nimport { useDispatch, useSelector } from \"react-redux\";\n\nexport default function SignupPage() {\n  const router = useRouter();\n  const dispatch = useDispatch();\n  const { isAuthenticated } = useSelector((state) => state.auth);\n\n  const [form, setForm] = useState({\n    fullName: \"\",\n    username: \"\",\n    email: \"\",\n    contact: \"\",\n    password: \"\",\n    confirmPassword: \"\",\n  });\n\n  const [errors, setErrors] = useState({});\n  const [touched, setTouched] = useState({});\n  const [showPassword, setShowPassword] = useState(false);\n  const [showConfirmPassword, setShowConfirmPassword] = useState(false);\n  const [isSubmitting, setIsSubmitting] = useState(false);\n  const [usernameChecking, setUsernameChecking] = useState(false);\n  const [usernameAvailable, setUsernameAvailable] = useState(null);\n\n  useEffect(() => {\n    if (isAuthenticated) {\n      router.push(\"/dashboard\");\n    }\n  }, [isAuthenticated, router]);\n\n  const handleChange = (e) => {\n    const { name, value } = e.target;\n    setForm((prev) => ({ ...prev, [name]: value }));\n    if (errors[name]) {\n      setErrors((prev) => ({ ...prev, [name]: \"\" }));\n    }\n    if (name === \"username\" && value) {\n      setUsernameAvailable(null);\n    }\n  };\n\n  const handleBlur = async (e) => {\n    const { name, value } = e.target;\n    setTouched((prev) => ({ ...prev, [name]: true }));\n    validateField(name, value);\n\n    if (name === \"username\" && value) {\n      await checkUsernameAvailability(value);\n    }\n  };\n\n  const validateField = (name, value) => {\n    const newErrors = { ...errors };\n    switch (name) {\n      case \"fullName\":\n        if (!value.trim()) {\n          newErrors.fullName = \"Full name is required\";\n        } else if (value.trim().length < 2) {\n          newErrors.fullName = \"Full name must be at least 2 characters\";\n        } else {\n          delete newErrors.fullName;\n        }\n        break;\n\n      case \"username\":\n        if (!value.trim()) {\n          newErrors.username = \"Username is required\";\n        } else if (!/^[a-zA-Z0-9_]{3,20}$/.test(value)) {\n          newErrors.username = \"Username must be 3-20 chars (letters, numbers, underscores)\";\n        } else {\n          delete newErrors.username;\n        }\n        break;\n\n      case \"email\":\n        if (!value.trim()) {\n          newErrors.email = \"Email is required\";\n        } else if (!/^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(value)) {\n          newErrors.email = \"Invalid email address\";\n        } else {\n          delete newErrors.email;\n        }\n        break;\n\n      case \"contact\":\n        if (!value.trim()) {\n          newErrors.contact = \"Contact number is required\";\n        } else if (!/^[0-9]{10}$/.test(value.replace(/\\D/g, \"\"))) {\n          newErrors.contact = \"Please enter a valid 10-digit phone number\";\n        } else {\n          delete newErrors.contact;\n        }\n        break;\n\n      case \"password\":\n        if (!value) {\n          newErrors.password = \"Password is required\";\n        } else if (value.length < 6) {\n          newErrors.password = \"Password must be at least 6 characters\";\n        } else if (!/(?=.*[a-zA-Z])(?=.*[0-9])/.test(value)) {\n          newErrors.password = \"Password must contain letters and numbers\";\n        } else {\n          delete newErrors.password;\n        }\n        break;\n\n      case \"confirmPassword\":\n        if (!value) {\n          newErrors.confirmPassword = \"Please confirm your password\";\n        } else if (value !== form.password) {\n          newErrors.confirmPassword = \"Passwords do not match\";\n        } else {\n          delete newErrors.confirmPassword;\n        }\n        break;\n    }\n    setErrors(newErrors);\n  };\n\n  const checkUsernameAvailability = async (username) => {\n    if (!username || !/^[a-zA-Z0-9_]{3,20}$/.test(username)) return;\n\n    try {\n      setUsernameChecking(true);\n      const res = await axios.post(\"/api/auth/check-username\", { username });\n      setUsernameAvailable(res.data.available);\n      if (!res.data.available) {\n        setErrors((prev) => ({ ...prev, username: \"Username already taken\" }));\n      }\n    } catch (err) {\n      console.error(\"Error checking username:\", err);\n    } finally {\n      setUsernameChecking(false);\n    }\n  };\n\n  const validateForm = () => {\n    const newErrors = {};\n    Object.keys(form).forEach((key) => {\n      validateField(key, form[key]);\n    });\n    return Object.keys(newErrors).length === 0 && usernameAvailable;\n  };\n\n  const handleSignup = async (e) => {\n    e.preventDefault();\n\n    if (!usernameAvailable) {\n      toast.error(\"Please check username availability\");\n      return;\n    }\n\n    if (Object.keys(errors).length > 0) {\n      toast.error(\"Please fix all errors before submitting\");\n      return;\n    }\n\n    setIsSubmitting(true);\n\n    try {\n      const res = await axios.post(\"/api/auth/signup\", form);\n\n      if (res.data.success) {\n        dispatch(loginSuccess({ user: res.data.user }));\n        toast.success(res.data.message || \"Account created successfully\");\n        setTimeout(() => {\n          window.location.href = \"/dashboard\";\n        }, 500);\n      }\n    } catch (err) {\n      const errorMessage = err.response?.data?.error || \"Signup failed\";\n      toast.error(errorMessage);\n    } finally {\n      setIsSubmitting(false);\n    }\n  };\n\n  if (isAuthenticated) {\n    return (\n      <div className=\"min-h-screen bg-white flex items-center justify-center\">\n        <div className=\"text-center\">\n          <Loader2 className=\"w-8 h-8 animate-spin mx-auto mb-4 text-blue-600\" />\n          <p className=\"text-gray-600\">Redirecting...</p>\n        </div>\n      </div>\n    );\n  }\n\n  const fields = [\n    {\n      name: \"fullName\",\n      label: \"Full Name\",\n      type: \"text\",\n      placeholder: \"John Doe\",\n      icon: User,\n      delay: 0.1,\n    },\n    {\n      name: \"username\",\n      label: \"Username\",\n      type: \"text\",\n      placeholder: \"john_doe\",\n      icon: User,\n      delay: 0.15,\n      hasCheck: true,\n    },\n    {\n      name: \"email\",\n      label: \"Email Address\",\n      type: \"email\",\n      placeholder: \"you@example.com\",\n      icon: Mail,\n      delay: 0.2,\n    },\n    {\n      name: \"contact\",\n      label: \"Phone Number\",\n      type: \"tel\",\n      placeholder: \"+91 9876543210\",\n      icon: Phone,\n      delay: 0.25,\n    },\n    {\n      name: \"password\",\n      label: \"Password\",\n      type: \"password\",\n      placeholder: \"••••••••\",\n      icon: Lock,\n      delay: 0.3,\n      isPassword: true,\n      showToggle: showPassword,\n      setShowToggle: setShowPassword,\n    },\n    {\n      name: \"confirmPassword\",\n      label: \"Confirm Password\",\n      type: \"password\",\n      placeholder: \"••••••••\",\n      icon: Lock,\n      delay: 0.35,\n      isPassword: true,\n      showToggle: showConfirmPassword,\n      setShowToggle: setShowConfirmPassword,\n    },\n  ];\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-blue-50 via-white to-purple-50 flex items-center justify-center px-4 sm:px-6 py-8 sm:py-12\">\n      {/* Back Button */}\n      <Link\n        href=\"/\"\n        className=\"absolute top-4 left-4 sm:top-6 sm:left-6 flex items-center gap-2 text-gray-600 hover:text-blue-600 transition-colors\"\n      >\n        <ChevronLeft className=\"w-5 h-5\" />\n        <span className=\"text-sm font-medium\">Back</span>\n      </Link>\n\n      {/* Main Container */}\n      <motion.div\n        initial={{ opacity: 0, y: 20 }}\n        animate={{ opacity: 1, y: 0 }}\n        transition={{ duration: 0.5 }}\n        className=\"w-full max-w-md\"\n      >\n        {/* Card */}\n        <div className=\"bg-white rounded-2xl shadow-lg border border-gray-100 p-6 sm:p-8 md:p-10\">\n          {/* Header */}\n          <div className=\"text-center mb-8 sm:mb-10\">\n            <Link href=\"/\" className=\"inline-block mb-6\">\n              <span className=\"text-2xl sm:text-3xl font-bold\">\n                Split<span className=\"bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent\">Wise</span>\n              </span>\n            </Link>\n            <h1 className=\"text-2xl sm:text-3xl font-bold text-gray-900 mb-2\">Create Account</h1>\n            <p className=\"text-gray-600 text-sm\">Join thousands splitting expenses smarter</p>\n          </div>\n\n          {/* Form */}\n          <form onSubmit={handleSignup} className=\"space-y-4 sm:space-y-5\">\n            {fields.map((field) => (\n              <motion.div\n                key={field.name}\n                initial={{ opacity: 0, y: 20 }}\n                animate={{ opacity: 1, y: 0 }}\n                transition={{ delay: field.delay }}\n              >\n                <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                  {field.label}\n                </label>\n                <div className=\"relative\">\n                  <field.icon className=\"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400\" />\n                  <input\n                    type={field.isPassword ? (field.showToggle ? \"text\" : \"password\") : field.type}\n                    name={field.name}\n                    value={form[field.name]}\n                    onChange={handleChange}\n                    onBlur={handleBlur}\n                    placeholder={field.placeholder}\n                    className={`w-full pl-10 pr-10 py-3 rounded-lg border-2 transition-all focus:outline-none text-sm ${\n                      touched[field.name] && errors[field.name]\n                        ? \"border-red-500 bg-red-50\"\n                        : \"border-gray-200 bg-gray-50 focus:border-blue-500 focus:bg-white\"\n                    }`}\n                  />\n\n                  {/* Right Icon - Check or Toggle */}\n                  {field.isPassword ? (\n                    <button\n                      type=\"button\"\n                      onClick={() => field.setShowToggle(!field.showToggle)}\n                      className=\"absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 transition-colors\"\n                    >\n                      {field.showToggle ? (\n                        <EyeOff className=\"w-5 h-5\" />\n                      ) : (\n                        <Eye className=\"w-5 h-5\" />\n                      )}\n                    </button>\n                  ) : field.hasCheck ? (\n                    <div className=\"absolute right-3 top-1/2 -translate-y-1/2\">\n                      {usernameChecking ? (\n                        <Loader2 className=\"w-5 h-5 animate-spin text-blue-600\" />\n                      ) : usernameAvailable ? (\n                        <CheckCircle className=\"w-5 h-5 text-green-600\" />\n                      ) : usernameAvailable === false ? (\n                        <div className=\"w-5 h-5 rounded-full bg-red-600\" />\n                      ) : null}\n                    </div>\n                  ) : null}\n                </div>\n\n                {/* Error Message */}\n                {touched[field.name] && errors[field.name] && (\n                  <p className=\"text-red-600 text-sm mt-2\">{errors[field.name]}</p>\n                )}\n\n                {/* Username Available Message */}\n                {field.hasCheck && usernameAvailable && (\n                  <p className=\"text-green-600 text-sm mt-2\">✓ Username is available</p>\n                )}\n              </motion.div>\n            ))}\n\n            {/* Submit Button */}\n            <motion.button\n              initial={{ opacity: 0, y: 20 }}\n              animate={{ opacity: 1, y: 0 }}\n              transition={{ delay: 0.4 }}\n              whileHover={{ scale: 1.02 }}\n              whileTap={{ scale: 0.98 }}\n              type=\"submit\"\n              disabled={isSubmitting || !usernameAvailable}\n              className=\"w-full py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-lg font-semibold hover:shadow-lg transition-all disabled:opacity-60 disabled:cursor-not-allowed flex items-center justify-center gap-2 mt-8\"\n            >\n              {isSubmitting ? (\n                <>\n                  <Loader2 className=\"w-4 h-4 animate-spin\" />\n                  <span>Creating Account...</span>\n                </>\n              ) : (\n                <>\n                  <span>Create Account</span>\n                  <ArrowRight className=\"w-4 h-4\" />\n                </>\n              )}\n            </motion.button>\n          </form>\n\n          {/* Divider */}\n          <div className=\"my-6 flex items-center gap-3\">\n            <div className=\"flex-1 h-px bg-gray-200\" />\n            <span className=\"text-sm text-gray-500\">Already have an account?</span>\n            <div className=\"flex-1 h-px bg-gray-200\" />\n          </div>\n\n          {/* Login Link */}\n          <p className=\"text-center text-gray-600 text-sm\">\n            Sign in{\" \"}\n            <Link\n              href=\"/login\"\n              className=\"text-blue-600 font-semibold hover:text-blue-700 transition-colors\"\n            >\n              here\n            </Link>\n          </p>\n        </div>\n\n        {/* Footer Info */}\n        <p className=\"text-center text-xs text-gray-500 mt-6 sm:mt-8\">\n          By creating an account, you agree to our{\" \"}\n          <Link href=\"#terms\" className=\"text-blue-600 hover:underline\">\n            Terms of Service\n          </Link>\n          {\" \"}and{\" \"}\n          <Link href=\"#privacy\" className=\"text-blue-600 hover:underline\">\n            Privacy Policy\n          </Link>\n        </p>\n      </motion.div>\n    </div>\n  );\n}\n